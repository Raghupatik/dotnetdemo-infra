pipeline {
  agent any

  environment {
    AWS_ACCESS_KEY_ID="${params.ACCESS_KEY}"
    AWS_SECRET_ACCESS_KEY="${params.SECRET_KEY}"
  }

  stages {
    stage('Init') {
      steps {
          sh "terraform init -reconfigure -backend-config params/${params.tfenv}.backend.tfvars"
      }
    }

    stage('Plan') {
      steps {
        sh "terraform plan --var-file='params/${params.tfenv}.tfvars'"
      }
    }

    stage('Apply') {
      when {
        expression {
          return !['none'].contains(params.tfenv)
        }
      }
      steps {
        input 'Do you want to apply changes ?'
        sh "terraform apply --var-file='params/${params.tfenv}.tfvars' --auto-approve"
      }
    }

     stage('Destroy') {
      steps {
        input 'Do you want to destroy changes ?'
        sh "terraform destroy --var-file='params/${params.tfenv}.tfvars' --auto-approve"
      }
    }
  }

  post {
    always {
      echo 'done'
    }
  }
}