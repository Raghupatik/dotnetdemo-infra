pipeline {
  agent any


  environment {
    VARFILE = "params/${params.tfenv}.tfvars"
    AWS_ACCESS_KEY_ID = "${params.ACCESS_KEY}"
    AWS_SECRET_ACCESS_KEY="${params.SECRET_KEY}"
  }

  stages {
    stage('Init') {
      steps {
          sh "terraform init -reconfigure -backend-config params/${params.tfenv}.backend.tfvars"
      }
    }

    stage('Plan') {
      when {
        expression {
          return !['none'].contains(params.tfenv)
        }
      }
      steps {
        sh "terraform plan --var-file='${VARFILE}'"
      }
    }

    stage('Apply') {
       when {
        branch 'feature/jenkins'
        expression {
          return !['none'].contains(params.tfenv)
        }
      }
      steps {
        input 'Apply ?'
        sh "terraform apply --var-file='${VARFILE}' --auto-approve"
      }
    }

     stage('Destroy') {
      steps {
        input 'destroy ?'
        sh "terraform destroy --var-file='${VARFILE}' --auto-approve"
      }
    }
  }
}